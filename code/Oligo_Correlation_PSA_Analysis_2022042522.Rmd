---
title: "Oligos Correlation and PSA Ananlysis"
author: "Harry Smith"
date: "R Sys.Date()"
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    fig_caption: yes
    fig_retina: 1 
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(cache.lazy = FALSE)
```


```{r libs, message=FALSE, warning=FALSE, echo=FALSE}
library(Seurat)
library(cowplot)
library(RColorBrewer)
library(Matrix)
library(tidyverse)
library(R.utils)
library(viridis)
library(patchwork)
library(Matrix.utils)
library(magrittr)
library(CelliD)

data_dir <- "/Users/smithh/Documents/Saba_Lab/cellranger_results"
tcols <- rev(brewer.pal(11, "RdGy")[c(1:5, 7)])[1:6]
```

## Experiment Summary

Sample | Description
------------- | ---------------- 
4_BNLx_2_Oligos | BNLx Biological Replicate 1 
6_SHR_1_Oligos | SHR Biological Replicate 1
8_SHR_2_Oligos | SHR Biological Replicate 2  

```{r import data}
# import oligo data sets
oligos <- readRDS(file = paste0(data_dir, "/", "oligos_default.rds"))

# sub cluster seurat object
oligos_sub <- readRDS(file = paste0(data_dir, "/", "oligos_subcluster.rds"))

```

```{r pseudo_counts}
library(purrr)
#########################################
# prep seurat object
#########################################

# Extract raw counts and metadata to create SingleCellExperiment object
counts <- oligos@assays$RNA@counts 

metadata <- oligos@meta.data

# Set up metadata as desired for aggregation and DE analysis
metadata$seurat_clusters <- factor(oligos@active.ident)

# Create single cell experiment object
sce <- SingleCellExperiment(assays = list(counts = counts), 
                           colData = metadata)

# Identify groups for aggregation of counts
groups <- colData(sce)[, c("seurat_clusters", "expt")]


# Named vector of cluster names
kids <- purrr::set_names(levels(sce$seurat_clusters))
kids

# Total number of clusters
nk <- length(kids)
nk

# Named vector of sample names
sids <- purrr::set_names(levels(sce$expt))

# Total number of samples 
ns <- length(sids)
ns

##################################
# Generate sample level metadata
##################################

## Determine the number of cells per sample
table(sce$expt)

## Turn named vector into a numeric vector of number of cells per sample
n_cells <- as.numeric(table(sce$expt))

## Determine how to reoder the samples (rows) of the metadata to match the order of sample names in sids vector
m <- match(sids, sce$expt)

## Create the sample level metadata by combining the reordered metadata with the number of cells corresponding to each sample.
ei <- data.frame(colData(sce)[m, ], 
                  n_cells, row.names = NULL) %>% 
                select(-"seurat_clusters")
ei

#####################################################
# Aggregate the counts per sample_id and cluster_id
#####################################################

# Subset metadata to only include the cluster and sample IDs to aggregate across
groups <- colData(sce)[, c("seurat_clusters", "expt")]

# Aggregate across cluster-sample groups
pb <- aggregate.Matrix(t(counts(sce)), 
                       groupings = groups, fun = "sum") 

class(pb)

dim(pb)

pb[1:6, 1:6]

# Not every cluster is present in all samples; create a vector that represents how to split samples
splitf <- sapply(stringr::str_split(rownames(pb), 
                                    pattern = "_",  
                                    n = 2), 
                 `[`, 1)

# Turn into a list and split the list into components for each cluster and transform, so rows are genes and columns are samples and make rownames as the sample IDs
pb <- split.data.frame(pb, 
                       factor(splitf)) %>%
        lapply(function(u) 
                set_colnames(t(u), 
                             stringr::str_extract(rownames(u), "(?<=_)[:alnum:]+")))

class(pb)

# Explore the different components of list
str(pb)

# Print out the table of cells in each cluster-sample group
options(width = 100)
table(sce$seurat_clusters, sce$expt)

```